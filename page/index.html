<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="./style/index.css">
  <link rel="stylesheet" type="text/css" href="./style/person.css">
  <link rel="stylesheet" type="text/css" href="./style/wechat.css">
  <script type="text/javascript"  src="./utils/index"></script>
</head>
<body>
  <!-- 人员信息库录入 start -->
  <div class="container person">
    <div class="desc cell">
      <div class="name item">
        <span class="txt">name:</span>
        <input type="text" maxlength="10" name="f_name" onchange="_descData['name'] = this.value">
      </div>
      <div class="age item">
        <span>age:</span>
        <input type="number" max="100" name="f_age" onchange="_descData['age'] = this.value">
      </div>
      <div class="image item">
        <span>image:</span>
        <div class="upload" id="uploadImg">
          <input type="file" accept="image" name="f_image" onchange="handlerImgChange(this)">
        </div>
        <div class="preview" id="previewImg"></div>
      </div>
      <div class="btn">
        <button class="reset" onclick="handlerReset()">reset</button>
        <button class="submit" onclick="handlerSubmit(this, 'submit')">submit</button>
      </div>
    </div>
    <div class="table cell">
      <div class="table">
        <table>
          <thead>
            <tr>
              <td>姓名</td>
              <td>年龄</td>
              <td>头像</td>
              <td>操作</td>
            </tr>
          </thead>
        </table>
      </div>
      <div class="pagination"></div>
    </div>
  </div>
  <!-- 人员信息库录入 end -->
  <!-- 新闻天气 start -->
  <div class="container request">
  </div>
  <!-- 新闻天气 end -->
  <!-- 聊天 start-->
  <div class="container wechat">
    <div class="login cell">
      <div class="account item">
        <span class="txt">account:</span>
        <input type="text" placeholder="从上面的列表选一个账号" onchange="_loginData['account'] = this.value">
      </div>
      <div class="password item">
        <span class="txt">password:</span>
        <input type="password" placeholder="账号名称加年龄" onchange="_loginData['password'] = this.value">
      </div>
      <div class="btn item">
        <button class="public_cursor" onclick="login(event)">login</button>
      </div>
    </div>
    <div class="control cell">
      <div class="searcher">
        <div class="search_item search_friend"></div>
        <div class="search_item add_friend"></div>
      </div>
      <div class="friend_list"></div>
    </div>
    <div class="view cell">
      <div class="title"></div>
      <div calss="chat_conten"></div>
    </div>
  </div>
   <!-- 聊天 end-->
</body>
<script>
let _loginData = {
  account: '',
  password: ''
}
let _descData = {
      name: '',
      age: '',
      image: ''
    }
let _tableData = []
/*
  target：目标元素
  处理选择图片
*/
const handlerImgChange = function (target) {
  const file = target.files[0]
  if (~file.type.indexOf('image')) {
    let reader = new FileReader()
    reader.readAsDataURL(file)
    reader.onload = function (e) {
      const newUrl = this.result
      const previewImgNode = $('#previewImg')
      const uploadImgNode = $('#uploadImg')
      uploadImgNode.style.display = 'none'
      previewImgNode.style.backgroundImage = `url(${newUrl})`
      previewImgNode.style.display = 'inline-block'
      _descData.image = newUrl
    }
  } else {
    new AlertMsg('请上传图片类文件！', 'warning')
  }
}
/*
  重置
*/
const handlerReset = function(e) {
  console.log('reset', e)
}
/*
  提交
*/
const handlerSubmit = async function(e, type) {
 let allow = true
 for (const key in _descData) {
   if (_descData[key].trim() === '') {
    new AlertMsg('请把信息填完整', 'warning')
     allow = false
     break
   }
 }
 if (!allow) return
 type = type === 'submit' ? 'add' : 'update'
 try {
  const params = {..._descData, id: this.id}
  const { code, data, msg } = await fetchRequest(`api/${type}`, params, 'post')
  if (code === 0) {
   new AlertMsg(`${type} success`)
    if (type === 'submit') { 
     _tableData = _tableData.concat(data.list)
     renderList(_tableData)
    } else {{
     getPersonList()
     this.cancel(e)
    }}
  } else {
   new AlertMsg(msg, 'error') 
  } 
 } catch (error) {
  console.error('error', error)
 }
}
/**
 * 获取人员列表
*/
const getPersonList = async function() {
  try {
    const { code, data: { list }, msg } = await fetchRequest(`api/list`)
    _tableData = list
    renderList(list) 
  } catch (error) {
    console.error('error', error)
  }
}
// 渲染人员列表
const renderList = function (list) {
  const table = $('table')
  const tbodyNode = $('tbody')
  const tbody = document.createElement('tbody')
  const trs = []
  tbodyNode && table.removeChild(tbodyNode)
  list.map(item => {
    const tr = document.createElement('tr')
    const td = document.createElement('td')
    const btnUpdate = document.createElement('button')
    const btnDel = document.createElement('button')
    // tr.setAttribute('class', 'item')
    btnDel.innerText = 'delete'
    btnDel.addEventListener('click', handleDelete.bind(item))
    btnUpdate.innerText = 'update'
    btnUpdate.addEventListener('click', handleUpdate.bind(item))
    item.image = `data:image/png;base64,${item.image}`
    // tr.innerHTML = '<div><button class="updateBtn" click="handleUpdate">delete</button><button class="deleteBtn" click="handleDelete">delete</button><button class="deleteBtn" click="handleDelete">delete</button></div>'
    for (const key in item) {
      if (~['_id'].indexOf(key)) continue
      const td = document.createElement('td')
      if (key === 'image') {
        const img = document.createElement('img')
        img.addEventListener('click', handlePreview.bind(item))
        img.setAttribute('src', item[key])
        td.appendChild(img)
        // td.innerHTML = `<img src='data:image/png;base64,${item[key]}' onclick="handlePreivew(event)" width='20px' height='20px'/>`
      } else {
        td.innerHTML = `<span class='txt'>${item[key]}</span>`
      }
      tr.appendChild(td)
    }
    td.appendChild(btnUpdate)
    td.appendChild(btnDel)
    tr.appendChild(td)
    tbody.appendChild(tr)
  })
  table.appendChild(tbody)
}
// 人员信息更新
const handleUpdate = function(e) {
  const { _id: id, name, age, image: src } = this
  const node = $('.desc').cloneNode(true)
  new RenderInfoPreview({ id, name, age, src, node }).render()
}
// 删除人员
const handleDelete = async function(e) {
  // document.removeChild(e.target)
  const { name } = this
  _tableData.some((item, index) => {
    if(item.name === name) {
      _tableData.splice(1, index)
      $('tbody').removeChild($All('tbody tr')[index])
      return true
    }
  })
  try {
    const { code, msg, data } = await fetchRequest('api/delete', { name }, 'POST')
    if(code === 0) {
      new AlertMsg('删除成功')
    } else {
      new AlertMsg(msg)
    } 
  } catch (error) {
    console.error('error', error)
  }
}
// 获取新闻列表
const getNewsList = async function () {
  try {
    const { code, data, msg } = await fetchRequest('api/news')
    console.log(data) 
  } catch (error) {
    console.error('error', error)
  }
}
// 图片预览
const handlePreview = function(e) {
  new RenderImgPreview({src: this.image}).render()
}
getPersonList()

/**************wechat************/
const websocket = new WebSocket('ws://localhost:3001')
websocket.onopen = function() {
  console.log('open')
}
websocket.onerror = function(err) {
  console.warn('err', err)
}
websocket.onmessage = function(res) {
  console.log('res', res)
}
const searcher = new Searcher($('.search_friend'), 'search')
const adder = new Searcher($('.add_friend'), 'add')
const login = async function(e) {
  const { account, password } = _loginData
  if(!account.trim()) return new AlertMsg('请填写账号', 'warning')
  if(!password.trim()) return new AlertMsg('请填写密码', 'warning')
  try {
    const { code, msg, data } = await fetchRequest('api/login', {account, password}, 'POST')
    if(code === 0) {
      localStorage.setItem('_TOKEN', data.token)
      localStorage.setItem('_INFO', JSON.stringify(data.info))
      new AlertMsg('登录成功')
    } else {
      new AlertMsg(msg, 'error')
    }
    console.log(code, msg, data) 
  } catch (error) {
    console.error('error', error)
  }
}
// getNewsList()
</script>
</html>